<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foto KTS - Editor Kartu Tanda Santri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0FAFA; /* Warna latar belakang yang lembut */
        }
        .btn {
            background-color: #006A4E; /* Warna hijau tua dari desain */
            color: white;
            font-weight: bold;
            border-radius: 9999px; /* rounded-full */
            padding: 0.75rem 2rem;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            background-color: #00563f;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        .text-brand {
            color: #002D21; /* Warna teks yang sangat gelap */
        }
        
        /* --- Animasi --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .animate-entry {
            opacity: 0; /* Mulai dalam keadaan transparan */
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .animate-exit {
            animation: fadeOutUp 0.4s ease-in forwards;
        }

        .page {
            /* Dihapus: transition: opacity 0.4s ease-in-out, visibility 0.4s; */
        }

        /* Dihapus: .page.is-hidden karena digantikan oleh class 'hidden' dari Tailwind */

        #preview-gallery {
            transition: opacity 0.3s ease-in;
        }

    </style>
</head>
<body class="text-brand">

    <!-- Halaman 1: Landing Page -->
    <div id="page1" class="page min-h-screen flex flex-col justify-center items-center text-center p-4">
        <img src="https://iili.io/KkzAuwv.png" alt="Logo" class="h-28 w-28 mb-6 animate-entry" style="animation-delay: 100ms;" border="0">
        <h2 class="text-3xl font-bold animate-entry" style="animation-delay: 200ms;">
            Foto<span class="bg-[#006A4E] text-white rounded-lg px-3 py-1 ml-2">KTS</span>
        </h2>
        <h1 class="text-5xl font-extrabold mt-2 tracking-tight animate-entry" style="animation-delay: 300ms;">Kartu Tanda Santri</h1>
        <p class="text-xl mt-3 text-gray-600 animate-entry" style="animation-delay: 400ms;">Pondok Pesantren Miftahul Ulum</p>
        <button id="getStartedBtn" class="btn mt-10 animate-entry" style="animation-delay: 500ms;">Getstarted</button>
    </div>

    <!-- Halaman 2: Editor Foto -->
    <div id="page2" class="page hidden min-h-screen flex-col p-6 md:p-10">
        <header class="flex items-center space-x-4">
            <img src="https://iili.io/KkzAuwv.png" alt="Logo" class="h-14 w-14" border="0">
            <div>
                <h2 class="text-xl font-bold">
                    Foto<span class="bg-[#006A4E] text-white rounded-md px-2 py-0.5 ml-1 text-lg">KTS</span>
                </h2>
                <h1 class="text-2xl font-extrabold tracking-tight">Kartu Tanda Santri</h1>
                <p class="text-md text-gray-600">Pondok Pesantren Miftahul Ulum</p>
            </div>
        </header>

        <main class="flex-grow flex flex-col justify-center items-center my-8">
            <!-- Area upload awal -->
            <div id="upload-area" class="w-full max-w-4xl text-center">
                <div class="bg-gray-200/50 rounded-2xl p-10 flex justify-center items-center h-80">
                     <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="currentColor" class="bi bi-card-image text-gray-400" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                        <path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2zM1 3.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5z"/>
                        <path d="M10.648 7.646a.5.5 0 0 1 .577-.093l4.777 3.947V13.5a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-1.266l4.777-3.947a.5.5 0 0 1 .577.093z"/>
                    </svg>
                </div>
            </div>
            <!-- Galeri pratinjau foto yang telah diproses -->
            <div id="preview-gallery" class="hidden w-full max-w-6xl grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Gambar yang diedit akan muncul di sini -->
            </div>
             <div id="processing-indicator" class="hidden mt-4 text-lg font-semibold text-gray-700">
                <p>Memproses gambar...</p>
            </div>
        </main>

        <footer class="flex justify-center items-center space-x-4">
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
            <button id="uploadBtn" class="btn">Upload Foto</button>
            <button id="downloadBtn" class="btn" disabled>Unduh Foto</button>
        </footer>
    </div>

    <script>
        // --- State Management ---
        let processedImages = []; // Menyimpan { name, blob }

        // --- DOM Elements ---
        const page1 = document.getElementById('page1');
        const page2 = document.getElementById('page2');
        const getStartedBtn = document.getElementById('getStartedBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const uploadArea = document.getElementById('upload-area');
        const previewGallery = document.getElementById('preview-gallery');
        const processingIndicator = document.getElementById('processing-indicator');

        // --- Navigation ---
        getStartedBtn.addEventListener('click', () => {
            // 1. Terapkan animasi keluar ke halaman 1
            page1.classList.add('animate-exit');

            // 2. Tunggu animasi selesai, lalu tukar halaman
            page1.addEventListener('animationend', () => {
                page1.classList.add('hidden'); // Sembunyikan sepenuhnya
                
                // Tampilkan halaman 2 dengan animasi masuk
                page2.classList.remove('hidden');
                page2.classList.add('flex', 'animate-entry');
            }, { once: true }); // Pastikan event listener hanya berjalan sekali
        });

        // --- File Upload & Processing ---
        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            // Jangan reset UI, cukup tambahkan foto baru
            uploadArea.classList.add('hidden');
            previewGallery.classList.remove('hidden');
            processingIndicator.classList.remove('hidden');
            downloadBtn.disabled = true; // Nonaktifkan tombol unduh selama proses

            // Dapatkan jumlah gambar yang sudah ada untuk delay animasi yang benar
            const existingImageCount = processedImages.length;
            const processingPromises = Array.from(files).map((file, index) => processImage(file, existingImageCount + index));
            await Promise.all(processingPromises);
            
            processingIndicator.classList.add('hidden');

            if (processedImages.length > 0) {
                downloadBtn.disabled = false;
            }

            // Reset input file agar bisa memilih file yang sama lagi jika diperlukan
            fileInput.value = '';
        });

        /**
         * Memproses satu file gambar: mengubah ukuran, memotong, dan membulatkan sudut.
         * Secara dinamis menyesuaikan resolusi untuk mendapatkan ukuran file di bawah 500KB.
         * @param {File} file - File gambar yang akan diproses.
         * @param {number} index - Indeks file untuk delay animasi.
         */
        function processImage(file, index) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        try {
                            const MAX_SIZE_BYTES = 500 * 1024; // 500 KB
                            const targetAspectRatio = 3 / 4;

                            // Hitung parameter pemotongan (crop) sekali saja
                            let sourceX = 0, sourceY = 0, sourceWidth = img.width, sourceHeight = img.height;
                            const originalAspectRatio = img.width / img.height;

                            if (originalAspectRatio > targetAspectRatio) {
                                sourceWidth = img.height * targetAspectRatio;
                                sourceX = (img.width - sourceWidth) / 2;
                            } else if (originalAspectRatio < targetAspectRatio) {
                                sourceHeight = img.width / targetAspectRatio;
                                sourceY = (img.height - sourceHeight) / 2;
                            }

                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            let currentWidth = 1200;
                            const minWidth = 150;
                            let finalBlob = null;

                            while (currentWidth >= minWidth) {
                                const currentHeight = currentWidth / targetAspectRatio;
                                canvas.width = currentWidth;
                                canvas.height = currentHeight;

                                const cornerRadius = currentWidth * (25 / 300);

                                ctx.beginPath();
                                ctx.moveTo(cornerRadius, 0);
                                ctx.lineTo(canvas.width - cornerRadius, 0);
                                ctx.arcTo(canvas.width, 0, canvas.width, cornerRadius, cornerRadius);
                                ctx.lineTo(canvas.width, canvas.height - cornerRadius);
                                ctx.arcTo(canvas.width, canvas.height, canvas.width - cornerRadius, canvas.height, cornerRadius);
                                ctx.lineTo(cornerRadius, canvas.height);
                                ctx.arcTo(0, canvas.height, 0, canvas.height - cornerRadius, cornerRadius);
                                ctx.lineTo(0, cornerRadius);
                                ctx.arcTo(0, 0, cornerRadius, 0, cornerRadius);
                                ctx.closePath();
                                ctx.clip();
                                
                                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, currentWidth, currentHeight);
                                
                                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                                
                                if (blob.size <= MAX_SIZE_BYTES) {
                                    finalBlob = blob;
                                    break;
                                }
                                
                                finalBlob = blob;
                                currentWidth -= 50;
                            }
                            
                            if (finalBlob.size > MAX_SIZE_BYTES) {
                                 console.warn(`File ${file.name} masih di atas 500KB pada resolusi terendah.`);
                            }

                            const fileName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                            processedImages.push({ name: `${fileName}.png`, blob: finalBlob });
                            
                            const previewUrl = URL.createObjectURL(finalBlob);
                            const previewImgContainer = document.createElement('div');
                            previewImgContainer.className = 'relative aspect-[3/4] bg-gray-200 rounded-lg overflow-hidden shadow-md group animate-entry';
                            previewImgContainer.style.animationDelay = `${index * 50}ms`; // Delay animasi bertingkat
                            previewImgContainer.dataset.filename = `${fileName}.png`;

                            const previewImg = document.createElement('img');
                            previewImg.src = previewUrl;
                            previewImg.className = 'w-full h-full object-cover';
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = '&times;';
                            deleteBtn.className = 'absolute top-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xl font-bold opacity-0 group-hover:opacity-100 transition-opacity';
                            deleteBtn.dataset.filename = `${fileName}.png`;

                            previewImgContainer.appendChild(previewImg);
                            previewImgContainer.appendChild(deleteBtn);
                            previewGallery.appendChild(previewImgContainer);

                            resolve();
                        } catch (error) {
                            console.error("Gagal memproses gambar:", error);
                            reject(error);
                        }
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- Delete Logic ---
        previewGallery.addEventListener('click', (event) => {
            if (event.target && event.target.tagName === 'BUTTON' && event.target.dataset.filename) {
                const filenameToDelete = event.target.dataset.filename;
                processedImages = processedImages.filter(img => img.name !== filenameToDelete);

                const elementToDelete = document.querySelector(`.group[data-filename="${filenameToDelete}"]`);
                if (elementToDelete) {
                    // Animasi sebelum menghapus
                    elementToDelete.style.transition = 'opacity 0.3s, transform 0.3s';
                    elementToDelete.style.opacity = '0';
                    elementToDelete.style.transform = 'scale(0.9)';
                    setTimeout(() => elementToDelete.remove(), 300);
                }

                if (processedImages.length === 0) {
                    downloadBtn.disabled = true;
                    uploadArea.classList.remove('hidden');
                    previewGallery.classList.add('hidden');
                }
            }
        });

        // --- Download Logic ---
        downloadBtn.addEventListener('click', async () => {
            if (processedImages.length === 0) return;

            if (processedImages.length === 1) {
                saveAs(processedImages[0].blob, processedImages[0].name);
                return;
            }

            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Menyiapkan ZIP...';
            const zip = new JSZip();
            processedImages.forEach(image => {
                zip.file(image.name, image.blob);
            });

            try {
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                saveAs(zipBlob, 'FotoKTS_Hasil.zip');
            } catch (error) {
                console.error("Gagal membuat file ZIP:", error);
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'Gagal membuat ZIP!';
                setTimeout(() => {
                    downloadBtn.textContent = originalText;
                }, 3000);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Unduh Foto';
            }
        });
    </script>
</body>
</html>



